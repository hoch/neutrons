<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drum Synthesis</title>
    <link rel="stylesheet" href="styles.css">
    <script src="slides.js" type="module"></script>
    <script type="module">
        import {Policy} from "./modules/policy.js";
        import {Drum} from "./worklets/Drum.js";
        import {StereoMeter} from "./worklets/StereoMeter.js";
        import {ParameterKnob} from "./modules/editors.js";

        const context = Policy.newAudioContext();
        Promise.all([
            StereoMeter.load(context),
            context.audioWorklet.addModule("./worklets/DrumProcessor.js")
        ]).then(_ => {
            console.log("...ready");
            const drum = new Drum(context);
            const meter = new StereoMeter(context);
            drum.connect(meter).connect(context.destination);

            const root = document.querySelector("div#sequencer");
            root.style.position = "relative";
            root.style.display = "flex";
            root.style.flexDirection = "column";
            const pattern = [];

            for (let channelIndex = 0; channelIndex < drum.channels.length; channelIndex++) {
                const channel = drum.channels[channelIndex];
                const div = document.createElement("div");
                div.style.marginBottom = "16px";
                const header = document.createElement("h4");
                header.textContent = channel.name;
                const controlDiv = document.createElement("div");
                for (let parameter of channel.parameters) {
                    controlDiv.appendChild(new ParameterKnob(parameter).domElement);
                }
                const rowDiv = document.createElement("div");
                pattern[channelIndex] = [];
                for (let step = 0; step < 16; step++) {
                    const stepButton = document.createElement("input");
                    stepButton.setAttribute("type", "checkbox");
                    stepButton.style.width = "16px";
                    stepButton.style.height = "16px";
                    if (0 < step && step % 4 === 0) {
                        stepButton.style.marginLeft = "32px";
                    }
                    rowDiv.appendChild(stepButton);
                    pattern[channelIndex][step] = false;
                    stepButton.onchange = ignore => {
                        pattern[channelIndex][step] = stepButton.checked;
                        drum.port.postMessage({action: "pattern", value: pattern});
                    }
                }
                div.appendChild(header);
                div.appendChild(controlDiv);
                div.appendChild(rowDiv);
                root.appendChild(div);
            }
            drum.port.postMessage({action: "pattern", value: pattern});
        });
    </script>
</head>
<body>
<header>
    <h1>Klangwerk</h1><h2>Drum Synthesis</h2>
</header>
<article class="center">
    <div id="sequencer"></div>
</article>
<footer></footer>
</body>
</html>