<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dub Station</title>
    <link rel="stylesheet" href="styles.css">
    <script src="slides.js" type="module"></script>
    <script type="module">
        import {Policy} from "./modules/policy.js";
        import {pulsarDelay} from "./modules/effects.js";
        import {SamplePlayer} from "./modules/sample-player.js";
        import {readAudio} from "./modules/standard.js";
        import {Sequencer} from "./modules/sequencing.js";

        const BPM = 140.0;
        const samples = [
            {url: "files/ghostsyndicate/GS_FREE4_140_DRUMLOOP_03_HAT.wav", name: "Hihats", duration: 4.0, loop: true, gain: 1.0},
            {url: "files/ghostsyndicate/GS_FREE4_140_SYNTH_02_Fm.wav", name: "Synth", duration: 4.0, loop: true, gain: 0.5},
            {url: "files/ghostsyndicate/GS_FREE4_140_BASS_08_Fm.wav", name: "Bass", duration: 4.0, loop: true, gain: 1.0},
            {url: "files/ghostsyndicate/GS_FREE4_140_DRUMLOOP_03_STP.wav", name: "Kick & Snare", duration: 4.0, loop: true, gain: 1.0},
            {url: "files/ghostsyndicate/GS_FREE4_140_DRUMLOOP_03_TOP.wav", name: "Icing", duration: 4.0, loop: true, gain: 0.5},
        ];

        const context = Policy.newAudioContext();
        const players = context.createGain();
        players.connect(context.destination);
        const sequencer = new Sequencer(() => context.currentTime * 1000.0);
        const delayInput = context.createGain();
        const delayOutput = context.createGain();
        delayOutput.gain.value = 0.7;
        delayOutput.connect(context.destination);
        pulsarDelay(context, delayInput, delayOutput, BPM);
        Promise.all(samples.map(sample => readAudio(context, sample.url)))
            .then(buffers => {
                for (let i = 0; i < samples.length; i++) {
                    const sample = samples[i];
                    const output = context.createGain();
                    output.connect(players);
                    const player = new SamplePlayer(context, delayInput, buffers[i], sample.name, sample.duration, sample.loop, sample.gain);
                    player.running = i === 0;
                    sequencer.addProcessor(player.sequencer(output));
                    const domElement = player.domElement;
                    domElement.style.marginBottom = "16px";
                    document.querySelector("div#players").appendChild(domElement);
                }
                sequencer.bpm.value = BPM;
                sequencer.start();
            });

    </script>
</head>
<body>
<header>
    <h1>Klangwerk</h1>
    <h2>Dub Station</h2>
</header>
<article class="center">
    <div id="players"></div>
</article>
<footer></footer>
</body>
</html>