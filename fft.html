<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fast Fourier Transformation</title>
    <link rel="stylesheet" href="styles.css">
    <script src="slides.js" type="module"></script>
    <script src="./lib/fft.js"></script>
    <script type="module">
        import {PlotterCanvas} from "./modules/plotter.js";
        import {replaceElement} from "./modules/standard.js";
        import {ParameterBuilder} from "./modules/parameter.js";
        import {ParameterField} from "./modules/editors.js";
        import {Linear, TwoFloats, PrintMapping} from "./modules/mapping.js";

        const fftSize = 16;
        const fftBins = fftSize / 2;
        const fft = new FFT(fftSize);
        const real = new Float32Array(fftSize);
        const imag = new Float32Array(fftSize);

        const pAmps = [];
        const pPhases = [];
        const callback = ignore => {
            let i = 0;
            for (; i < fftBins; i++) {
                const amplitude = pAmps[i].value;
                const phase = pPhases[i].value / 180.0 * Math.PI;
                imag[i] = amplitude * Math.cos(phase);
                real[i] = amplitude * Math.sin(phase);
            }
            for (; i < fftSize; i++) {
                imag[i] = 0.0;
                real[i] = 0.0;
            }
            fft.process(imag, real);
            plotter.setWaveform(real);
        };
        const createField = (parent, builder) => {
            const parameter = builder.create();
            parameter.addCallback(callback);
            parent.appendChild(new ParameterField(parameter).domElement);
            return parameter;
        };
        const ampControls = document.querySelector("div#amplitudes");
        const phaseControls = document.querySelector("div#phases");
        const ampBuilder = ParameterBuilder.begin("Amp")
            .valueMapping(Linear.Bipolar)
            .printMapping(TwoFloats)
            .unit("")
            .value(0.0);
        const phaseBuilder = ParameterBuilder.begin("Phase")
            .valueMapping(new Linear(-180.0, 180.0))
            .printMapping(PrintMapping.create((mapping, unipolar) => Math.round((unipolar - 0.5) * 360)))
            .unit("ยบ")
            .value(0.0);
        for (let i = 0; i < fftBins; i++) {
            pAmps[i] = createField(ampControls, ampBuilder);
            pPhases[i] = createField(phaseControls, phaseBuilder);
        }
        const plotter = new PlotterCanvas();
        plotter.modIndex = true;
        plotter.setYRange(-2.0, 2.0);
        plotter.setWaveform(real);
        replaceElement(plotter.domElement, document.querySelector("div#canvas"));

        const setShape = (type) => {
            for (let i = 0; i < fftBins; i++) {
                pAmps[i].value = 0.0;
                pPhases[i].value = 0.0;
            }
            switch (type) {
                case "sine" : {
                    pAmps[1].value = 1.0;
                    break;
                }
                case "square": {
                    for (let i = 0; i < fftBins; i++) {
                        const j = i * 2 + 1;
                        if (j >= fftBins) return false;
                        pAmps[j].value = 4.0 / (Math.PI * j);
                    }
                    break;
                }
                case "sawtooth": {
                    for (let i = 0; i < fftBins; i++) {
                        const j = i + 1;
                        if (j >= fftBins) return false;
                        const sign = i & 1 ? -1 : 1;
                        pAmps[j].value = 0.125 * sign * (2.0 * Math.PI / j);
                    }
                    break;
                }
                case "triangle": {
                    for (let i = 0; i < fftBins; i++) {
                        const j = i * 2 + 1;
                        if (j >= fftBins) return false;
                        const jp = j * Math.PI;
                        pAmps[j].value = 8.0 * Math.sin(jp * 0.5) / (jp * jp);
                    }
                    break;
                }
            }
        };
        document.querySelector("button#clear").onclick = ignore => setShape(undefined);
        document.querySelector("button#sine").onclick = ignore => setShape("sine");
        document.querySelector("button#triangle").onclick = ignore => setShape("triangle");
        document.querySelector("button#sawtooth").onclick = ignore => setShape("sawtooth");
        document.querySelector("button#square").onclick = ignore => setShape("square");
    </script>
</head>
<body>
<header>
    <h1>Klangwerk</h1>
    <h2>Fast Fourier Transformation</h2>
</header>
<article class="center">
    <div style="display: flex; flex-direction: column; width: 1200px;">
        <div style="height: 640px;">
            <div id="canvas"></div>
        </div>
        <div style="
        display: flex;
        flex-direction: row;
        background-color: #1A1A1A;
        height: 128px;
        justify-content: space-around;
        align-items: center;">
            <div style="display: flex; justify-content: center; align-items: center;">
                <button id="clear">clear</button>
                <button id="sine">sine</button>
                <button id="triangle">triangle</button>
                <button id="sawtooth">sawtooth</button>
                <button id="square">square</button>
            </div>
            <div style="display: flex; flex-direction: column;">
                <div id="amplitudes"></div>
                <div id="phases"></div>
            </div>
        </div>
    </div>
</article>
<footer></footer>
</body>
</html>