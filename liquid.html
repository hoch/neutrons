<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Liquid</title>
    <link rel="stylesheet" href="styles.css">
    <script src="slides.js" type="module"></script>
    <script type="module">
        import {Policy} from "./modules/policy.js";
        import {clamp, readAudio} from "./modules/standard.js";

        const context = Policy.newAudioContext();
        readAudio(context, "files/impulse/spaces/Large Wide Echo Hall.wav")
            .then(buffer => {
                const carrier = context.createOscillator();
                carrier.frequency.value = 120.0;
                carrier.type = "square";
                carrier.start();
                const convolver = context.createConvolver();
                convolver.buffer = buffer;
                const wetGain = context.createGain();
                wetGain.gain.value = 0.3;
                carrier.connect(convolver).connect(context.destination);
                carrier.connect(wetGain).connect(context.destination);

                const w = 512;
                const h = 512;
                let t0 = new Float32Array(w * h);
                let t1 = new Float32Array(w * h);
                const mapIndex = (x, y) => y * w + x;

                const canvas = document.createElement("canvas");
                canvas.width = w;
                canvas.height = w;
                document.body.appendChild(canvas);
                const graphics = canvas.getContext("2d");
                const imageData = graphics.getImageData(0, 0, w, h);
                const set = (x, y, r, g, b, a) => {
                    let index = mapIndex(x, y) * 4;
                    imageData.data[index++] = r * 255;
                    imageData.data[index++] = g * 255;
                    imageData.data[index++] = b * 255;
                    imageData.data[index] = a * 255;
                };

                const drop = event => {
                    const clientRect = canvas.getBoundingClientRect();
                    const x = event.clientX - clientRect.x;
                    const y = event.clientY - clientRect.y;
                    if (0 <= x && x < w && 0 <= y && y < h) {
                        t0[mapIndex(x, y)] = -2.0;
                        // t0[mapIndex(x + 1, y)] = 0.2;
                        // t0[mapIndex(x - 1, y)] = 0.2;
                        // t0[mapIndex(x, y + 1)] = 0.2;
                        // t0[mapIndex(x, y - 1)] = 0.2;
                    }
                };
                const onMouseMove = event => drop(event);
                const onMouseUp = ignore => {
                    window.removeEventListener("mousemove", onMouseMove);
                    window.removeEventListener("mouseup", onMouseUp);
                };
                window.addEventListener("mousedown", event => {
                    drop(event);
                    window.addEventListener("mousemove", onMouseMove);
                    window.addEventListener("mouseup", onMouseUp);
                });

                const run = () => {
                    for (let y = 1; y < h - 1; y++) {
                        for (let x = 1; x < w - 1; x++) {
                            const value = t1[mapIndex(x, y)];
                            let n = (((
                                t0[mapIndex(x + 1, y)] +
                                t0[mapIndex(x - 1, y)] +
                                t0[mapIndex(x, y + 1)] +
                                t0[mapIndex(x, y - 1)]
                            )) * 0.5) - value;
                            n *= 0.98;
                            t1[mapIndex(x, y)] = n;
                            const grey = clamp(0.0, 1.0, (Math.abs(value)) * 16.0);
                            set(x, y, grey, grey, grey, 1.0);
                        }
                    }
                    const x = 256;
                    const y = 256;
                    const value = t0[mapIndex(x + 1, y)] +
                        t0[mapIndex(x - 1, y)] +
                        t0[mapIndex(x, y + 1)] +
                        t0[mapIndex(x, y - 1)];
                    carrier.frequency.exponentialRampToValueAtTime(20.0 * Math.pow(2.0, value * 64.0), context.currentTime + 0.005);
                    set(256, 256, 1.0, 0.0, 1.0, 1.0);
                    const tp = t1;
                    t1 = t0;
                    t0 = tp;
                    graphics.putImageData(imageData, 0, 0);
                    window.requestAnimationFrame(run);
                };
                run();
            });
    </script>
</head>
<body>
<header>
    <h1>Klangwerk</h1>
    <h2>Liquid</h2>
</header>
</body>
</html>