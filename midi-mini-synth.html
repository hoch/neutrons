<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Midi Mini-Synth</title>
    <link rel="stylesheet" href="styles.css">
    <script src="slides.js" type="module"></script>
    <script type="module">
        import {Policy} from "./modules/policy.js";
        import {Midi, SoftwareKeyboard} from "./modules/sequencing.js";
        import {midiToFrequency, setTargetWithin} from "./modules/neutrons.js";
        import {Mapper} from "./worklets/Mapper.js";
        import {Exp, ThreeFloats, NoFloat} from "./modules/mapping.js";
        import {ParameterBuilder} from "./modules/parameter.js";
        import {ParameterKnob} from "./modules/editors.js";
        import {replaceElement} from "./modules/standard.js";

        const context = Policy.newAudioContext();
        const masterGain = context.createGain();
        masterGain.gain.value = 0.2;
        masterGain.connect(context.destination);

        const timeMapping = new Exp(0.001, 1.0);
        const pAttackTime = ParameterBuilder
            .begin("Attack Time")
            .valueMapping(timeMapping)
            .printMapping(ThreeFloats)
            .value(0.001)
            .unit("s")
            .create();
        const pReleaseTime = ParameterBuilder
            .begin("Release Time")
            .valueMapping(timeMapping)
            .printMapping(ThreeFloats)
            .value(0.500)
            .unit("s")
            .create();
        const pFilterFreq = ParameterBuilder
            .begin("Flt Freq")
            .valueMapping(new Exp(120.0, 20000.0))
            .printMapping(NoFloat)
            .value(600.0)
            .unit("hz")
            .create();
        const pFilterRes = ParameterBuilder
            .begin("Flt Res")
            .valueMapping(new Exp(0.01, 20.0))
            .value(0.01)
            .create();
        const pFilterEnv = ParameterBuilder
            .begin("Flt Env")
            .value(0.0)
            .create();
        const parameters = [
            pAttackTime,
            pReleaseTime,
            pFilterFreq,
            pFilterRes,
            pFilterEnv
        ];

        const attackSlope = 0.9;
        const releaseSlope = 0.4;
        const sustain = false;

        const playVoice = (startTime, note, velocity) => {
            const osc = context.createOscillator();
            const envelope = context.createConstantSource();
            const amplifier = context.createGain();
            const filterEnvGain = context.createGain();
            const filter = context.createBiquadFilter();
            const filterMapper = new Mapper(context);

            osc.type = "sawtooth";
            osc.frequency.value = midiToFrequency(note, 440.0);
            filterEnvGain.gain.value = pFilterEnv.value;
            filter.frequency.value = pFilterFreq.value;
            filter.Q.value = pFilterRes.value;
            filterMapper.mapping(x => 120.0 * Math.exp(x * Math.log(20000.0 / 20.0)));
            filter.type = "lowpass";
            envelope.offset.value = 0.0;
            amplifier.gain.value = 0.0;
            setTargetWithin(envelope.offset, 0.0, 1.0, startTime, startTime + pAttackTime.value, attackSlope);
            envelope.connect(amplifier.gain);
            envelope.connect(filterEnvGain).connect(filterMapper).connect(filter.frequency);
            osc.start(startTime);
            envelope.start(startTime);
            osc.connect(filter).connect(amplifier).connect(masterGain);
            let released = false;
            const release = (time) => {
                if (released) {
                    return;
                }
                const stopTime = time + pReleaseTime.value;
                envelope.offset.cancelScheduledValues(time);
                if (time < startTime + pAttackTime.value) {
                    const currentValue = 1.0 - Math.exp((startTime - time) / attackSlope);
                    setTargetWithin(envelope.offset, currentValue, 0.0, time, stopTime, releaseSlope);
                } else {
                    setTargetWithin(envelope.offset, 1.0, 0.0, time, stopTime, releaseSlope);
                }
                osc.stop(stopTime);
                envelope.stop(stopTime);
                released = true;
            };
            if (!sustain) {
                release(startTime + pAttackTime.value);
            }
            return release;
        };

        const start = () => {
            const actives = [];
            Midi.request()
                .then(midi => {
                    const events = Midi.mapAllEvents(midi);
                    const onNoteOn = (note, velocity) => actives[note] = playVoice(context.currentTime + 0.005, note, velocity);
                    const onNoteOff = (note) => actives[note](context.currentTime + 0.005);
                    events.onNoteOn = onNoteOn;
                    events.onNoteOff = onNoteOff;
                    events.onController = (id, unipolar) => {
                        const parameter = parameters[id - 1];
                        if (parameter) {
                            parameter.unipolar = unipolar;
                        }
                    };
                    SoftwareKeyboard.init(onNoteOn, onNoteOff);
                });
        };

        Promise.all([
            context.audioWorklet.addModule("worklets/MapperProcessor.js")
        ]).then(() => {
            replaceElement(new ParameterKnob(pAttackTime).domElement, document.querySelector("div#attack-time"));
            replaceElement(new ParameterKnob(pReleaseTime).domElement, document.querySelector("div#release-time"));
            replaceElement(new ParameterKnob(pFilterFreq).domElement, document.querySelector("div#filter-frequency"));
            replaceElement(new ParameterKnob(pFilterRes).domElement, document.querySelector("div#filter-resonance"));
            replaceElement(new ParameterKnob(pFilterEnv).domElement, document.querySelector("div#filter-envelope"));

            start();
        });
    </script>
</head>
<body>
<header>
    <h1>Klangwerk</h1>
    <h2>Midi Mini-Synth</h2>
</header>
<article class="center">
    <div id="attack-time"></div>
    <div id="release-time"></div>
    <div id="filter-frequency"></div>
    <div id="filter-resonance"></div>
    <div id="filter-envelope"></div>
</article>
<footer></footer>
</body>
</html>