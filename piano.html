<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Time Stretching</title>
    <link rel="stylesheet" href="styles.css">
    <script src="slides.js" type="module"></script>
    <script src="./lib/fft.js"></script>
    <script src="./third/brain.js"></script>
    <script type="module">
        import {Policy} from "./modules/policy.js";
        import {readAudio, replaceElement} from "./modules/standard.js";
        import {PlotterCanvas, PlotterRangeEvents} from "./modules/plotter.js";
        import {normalise, Windows, RMS} from "./modules/neutrons.js";

        const context = Policy.newAudioContext();

        // https://www.freesound.org/people/jobro/packs/2489/
        readAudio(context, "files/piano/39204__jobro__piano-ff-056.wav")
            .then(buffer => {
                const startTime = context.currentTime;
                const channelData = buffer.getChannelData(0);

                const rms = new RMS(64);

                let now;
                const length = channelData.length;
                const fftSize = 2048;
                const fftBins = fftSize / 2;
                const fft = new FFT(fftSize);
                const real = new Float32Array(fftSize);
                const imag = new Float32Array(fftSize);
                const win = Windows.generate(Windows.BlackmanHarris, fftSize);
                const fftOverlap = 256;
                const n = Math.floor(length / fftOverlap);
                now = performance.now();
                const transients = new Float64Array(n);
                for (let i = 0; i <= n; i++) {
                    const s0 = i * fftOverlap;
                    const s1 = s0 + fftSize;
                    const sn = Math.min(length, s1);
                    let j = s0, k = 0;
                    for (; j < sn; j++, ++k) {
                        real[k] = channelData[j] * win[k];
                    }
                    for (; k < fftSize; k++) {
                        real[k] = 0.0;
                    }
                    imag.fill(0.0);
                    fft.process(real, imag);
                    for (let l = 0; l < fftBins; l++) {
                        transients[i] += Math.sqrt(real[l] * real[l] + imag[l] * imag[l]);
                    }
                }
                console.log("length", length);
                console.log("fftSize", fftSize);
                console.log("fftOverlap", fftOverlap);
                console.log("performed", n, "fft in", (performance.now() - now).toFixed(1), "ms");

                const waveform = new PlotterCanvas();
                waveform.setWaveform(channelData);
                const spectrum = new PlotterCanvas();
                spectrum.setWaveform(transients);
                spectrum.setYRange(1.0, 0.0);

                normalise(transients);

                // const maxPeaks = extrema(transients, 0.05).maxlist.map(x => parseInt(x, 10));
                // for (let i = 0; i < maxPeaks.length; i++) {
                //     spectrum.addMarker(maxPeaks[i]);
                // }

                const container = document.querySelector("div#container");
                PlotterRangeEvents.attach(container, waveform.range);
                PlotterRangeEvents.attach(container, spectrum.range);
                replaceElement(waveform.domElement, document.querySelector("div#waveform"));
                replaceElement(spectrum.domElement, document.querySelector("div#spectrum"));

                const update = () => {
                    const seconds = context.currentTime - startTime;
                    waveform.setCursor((seconds * buffer.sampleRate) % length);
                    window.requestAnimationFrame(update);
                };
                update();
            });
    </script>
</head>
<body>
<header>
    <h1>Klangwerk</h1>
    <h2>Piano</h2>
</header>
<div style="width: 100%; height: 400px;" id="container">
    <div id="waveform"></div>
    <div id="spectrum"></div>
</div>
</body>
</html>