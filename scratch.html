<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scratch</title>
    <link rel="stylesheet" href="styles.css">
    <script src="slides.js" type="module"></script>
    <script type="module">
        import {Policy} from "./modules/policy.js";
        import {replaceElement, readAudio} from "./modules/standard.js";
        import {PlotterCanvas} from "./modules/plotter.js";
        import {Scratch} from "./worklets/Scratch.js";
        import {ScratchPattern} from "./modules/scratching.js";
        import {Fragmentation, Sequencer} from "./modules/sequencing.js";

        const context = Policy.newAudioContext();

        const pattern = ScratchPattern.TearExample;
        console.log("scratchesDuration", pattern.scratchesDuration);
        console.log("fadesDuration", pattern.fadesDuration);

        const numValues = 4096;
        const gates = new Float32Array(numValues);
        const positions = new Float32Array(numValues);
        pattern.restart();
        for (let i = 0; i < numValues; i++) {
            const time = i / numValues;
            gates[i] = pattern.getFade(time);
            positions[i] = pattern.getPos(time);
        }

        const plotFades = new PlotterCanvas();
        plotFades.setYRange(1.0, 0.0);
        plotFades.setWaveform(gates);
        const plotPositions = new PlotterCanvas();
        plotPositions.setYRange(1.0, 0.0);
        plotPositions.setWaveform(positions);
        // for (let i = 0; i < 16; i++) {
        //     plotPositions.addMarker(i * (numValues / 16));
        // }
        replaceElement(plotPositions.domElement, document.querySelector("div#positions"));
        replaceElement(plotFades.domElement, document.querySelector("div#fades"));

        Promise.all([
            readAudio(context, "files/scratch/ah-yeah.ogg"),
            // readAudio(context, "files/scratch/scratch.ogg"),
            // readAudio(context, "files/loops/hiphop-drum-loop-120bpm.ogg"),
            readAudio(context, "files/loops/hard-hitter-drum-loop.ogg"),
            context.audioWorklet.addModule("./worklets/ScratchProcessor.js"),
        ]).then(results => {
            const loopTempo = 150.0;
            const scratchNode = new Scratch(context);
            scratchNode.bpm(loopTempo);
            scratchNode.sample(results[0], 0.0, 1.0);
            const scratchGain = context.createGain();
            scratchGain.gain.value = 0.5;
            scratchNode.connect(scratchGain);
            scratchGain.connect(context.destination);
            scratchNode.port.onmessage = event => plotPositions.setCursor(event.data * 4096);

            const sequencer = new Sequencer(() => context.currentTime * 1000.0);
            const fragmentation = new Fragmentation((computeStartMillis, stepIndex, position) => {
                const seconds = computeStartMillis(position) / 1000.0;
                if (stepIndex % 128 === 0) {
                    const bufferSource = context.createBufferSource();
                    bufferSource.buffer = results[1];
                    bufferSource.start(seconds);
                    bufferSource.connect(context.destination);
                }
                if (stepIndex % 32 === 0) {
                    scratchNode.playPattern(pattern, seconds);
                }
            }, 1.0 / 16.0);
            sequencer.addProcessor((sequencer, t0, t1) => fragmentation.equalise(sequencer, t0, t1));
            sequencer.bpm.value = loopTempo;
            sequencer.start();
        });
    </script>
</head>
<body>
<header>
    <h1>Klangwerk</h1>
    <h2>Scratch</h2>
</header>
<div style="width: 1024px; height: 512px">
    <div id="positions"></div>
    <div id="fades"></div>
</div>
</body>
</html>