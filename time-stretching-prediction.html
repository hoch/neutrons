<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Time Stretching</title>
    <link rel="stylesheet" href="styles.css">
    <script src="slides.js" type="module"></script>
    <script src="./lib/fft.js"></script>
    <script src="./third/brain.js"></script>
    <script type="module">
        import {Policy} from "./modules/policy.js";
        import {readAudio, replaceElement} from "./modules/standard.js";
        import {PlotterCanvas, PlotterRangeEvents} from "./modules/plotter.js";
        import {normalise, Windows} from "./modules/neutrons.js";
        import {extrema} from "./third/diff.js";

        const context = Policy.newAudioContext();

        // readAudio(context, "files/loops/103616__deller24__loop3.wav")
        readAudio(context, "files/loops/crazy-drumbeat-1.wav")
            .then(buffer => {
                const startTime = context.currentTime;

                const bufferSource = context.createBufferSource();
                bufferSource.buffer = buffer;
                bufferSource.loop = true;
                bufferSource.start(startTime);
                bufferSource.connect(context.destination);

                let now;
                const channelData = buffer.getChannelData(0);
                const length = channelData.length;
                const fftSize = 512;
                const fftBins = fftSize / 2;
                const fft = new FFT(fftSize);
                const real = new Float32Array(fftSize);
                const imag = new Float32Array(fftSize);
                const win = Windows.generate(Windows.BlackmanHarris, fftSize);
                const fftOverlap = 16;
                const n = Math.floor(length / fftOverlap);
                now = performance.now();
                const transients = new Float64Array(n);
                for (let i = 0; i <= n; i++) {
                    const s0 = i * fftOverlap;
                    const s1 = s0 + fftSize;
                    const sn = Math.min(length, s1);
                    let j = s0, k = 0;
                    for (; j < sn; j++, ++k) {
                        real[k] = channelData[j] * win[k];
                    }
                    for (; k < fftSize; k++) {
                        real[k] = 0.0;
                    }
                    imag.fill(0.0);
                    fft.process(real, imag);
                    for (let l = 0; l < fftBins/8; l++) {
                        // Sum all bins
                        transients[i] += Math.sqrt(real[l] * real[l] + imag[l] * imag[l]);
                    }
                }
                console.log("length", length);
                console.log("fftSize", fftSize);
                console.log("fftOverlap", fftOverlap);
                console.log("performed", n, "fft in", (performance.now() - now).toFixed(1), "ms");

                const waveform = new PlotterCanvas();
                waveform.setWaveform(channelData);
                const spectrum = new PlotterCanvas();
                spectrum.setWaveform(transients);
                spectrum.setYRange(1.0, 0.0);

                normalise(transients);

                const maxPeaks = extrema(transients, 0.05).maxlist.map(x => parseInt(x, 10));
                for (let i = 0; i < maxPeaks.length; i++) {
                    spectrum.addMarker(maxPeaks[i]);
                }

                const collect = (array, index, half) => {
                    const n = half * 2 + 1;
                    const neighbours = new Float32Array(n);
                    for (let j = 0; j < n; j++) {
                        const nI = j - half + index;
                        neighbours[j] = 0 > nI ? 0.0 : nI >= array.length ? 0.0 : array[nI];
                    }
                    return neighbours;
                };

                const json = {"sizes":[33,3,1],"layers":[{"0":{},"1":{},"2":{},"3":{},"4":{},"5":{},"6":{},"7":{},"8":{},"9":{},"10":{},"11":{},"12":{},"13":{},"14":{},"15":{},"16":{},"17":{},"18":{},"19":{},"20":{},"21":{},"22":{},"23":{},"24":{},"25":{},"26":{},"27":{},"28":{},"29":{},"30":{},"31":{},"32":{}},{"0":{"bias":17.24156379699707,"weights":{"0":-15.892051696777344,"1":-14.635208129882812,"2":-11.87154769897461,"3":-6.810859203338623,"4":-2.626741886138916,"5":-7.76848840713501,"6":-14.16134262084961,"7":-19.789939880371094,"8":-17.217016220092773,"9":-9.345681190490723,"10":-0.512661337852478,"11":4.939680576324463,"12":4.716688632965088,"13":3.603123664855957,"14":-0.6411640644073486,"15":-3.5659196376800537,"16":-6.549825191497803,"17":-6.23738956451416,"18":-1.7174540758132935,"19":14.262839317321777,"20":17.563396453857422,"21":15.332745552062988,"22":8.811746597290039,"23":3.0128400325775146,"24":-1.6631338596343994,"25":-1.7438710927963257,"26":-1.6091537475585938,"27":-2.5130867958068848,"28":-4.354843616485596,"29":-5.506294250488281,"30":-5.806501865386963,"31":-2.7037031650543213,"32":2.8533480167388916}},"1":{"bias":-3.7400717735290527,"weights":{"0":7.040311336517334,"1":7.544841766357422,"2":7.634053707122803,"3":6.754092693328857,"4":4.953835964202881,"5":2.201429843902588,"6":1.6330662965774536,"7":0.2126036137342453,"8":-0.23783183097839355,"9":-1.1073870658874512,"10":-0.5318546891212463,"11":-0.790337085723877,"12":-1.7173954248428345,"13":-2.7054779529571533,"14":-4.073165416717529,"15":-4.1313676834106445,"16":-7.193565845489502,"17":-6.968708038330078,"18":-5.9336771965026855,"19":-3.379448652267456,"20":-2.385265588760376,"21":-1.9057717323303223,"22":-1.7468693256378174,"23":-0.8189134001731873,"24":0.0491844043135643,"25":1.6679494380950928,"26":2.7850115299224854,"27":3.7866625785827637,"28":4.050317764282227,"29":5.14345121383667,"30":6.681877136230469,"31":8.004973411560059,"32":10.341629028320312}},"2":{"bias":-39.830047607421875,"weights":{"0":18.670196533203125,"1":12.619063377380371,"2":6.70652961730957,"3":3.4844799041748047,"4":1.1019691228866577,"5":-3.440023422241211,"6":1.9145803451538086,"7":2.8370258808135986,"8":6.99268102645874,"9":10.908699035644531,"10":17.503997802734375,"11":20.70995330810547,"12":19.52899169921875,"13":16.18629264831543,"14":10.255398750305176,"15":9.202615737915039,"16":-6.342504501342773,"17":-8.80333137512207,"18":-7.967852592468262,"19":-2.228817939758301,"20":-2.4267284870147705,"21":-4.400023460388184,"22":-8.827729225158691,"23":-9.341851234436035,"24":-9.285065650939941,"25":-7.084076881408691,"26":-3.7206413745880127,"27":2.021740436553955,"28":3.8587937355041504,"29":6.661238670349121,"30":9.781188011169434,"31":13.190131187438965,"32":19.146137237548828}}},{"0":{"bias":9.103032112121582,"weights":{"0":-18.84430694580078,"1":-14.670496940612793,"2":-22.27364158630371}}}],"outputLookup":false,"inputLookup":false,"activation":"sigmoid","trainOpts":{"iterations":2000000,"errorThresh":0.005,"log":true,"logPeriod":500,"learningRate":0.3,"momentum":0.1,"callbackPeriod":1000}};

                const net = new brain.NeuralNetwork({
                    binaryThresh: 0.5,     // ¯\_(ツ)_/¯
                    hiddenLayers: [3],     // array of ints for the sizes of the hidden layers in the network
                    activation: 'sigmoid'  // supported activation types: ['sigmoid', 'relu', 'leaky-relu', 'tanh']
                });
                net.fromJSON(json);

                for (let i = 0; i < maxPeaks.length; i++) {
                    const peakIndex = maxPeaks[i];
                    const neighbours = collect(transients, peakIndex, 16);
                    console.log(net.run(neighbours));
                }

                const container = document.querySelector("div#container");
                PlotterRangeEvents.attach(container, waveform.range);
                PlotterRangeEvents.attach(container, spectrum.range);
                replaceElement(waveform.domElement, document.querySelector("div#waveform"));
                replaceElement(spectrum.domElement, document.querySelector("div#spectrum"));

                const update = () => {
                    const seconds = context.currentTime - startTime;
                    waveform.setCursor((seconds * buffer.sampleRate) % length);
                    window.requestAnimationFrame(update);
                };
                update();
            });
    </script>
</head>
<body>
<header>
    <h1>Klangwerk</h1>
    <h2>Time Stretching | Prediction</h2>
</header>
<div style="width: 100%; height: 400px;" id="container">
    <div id="waveform"></div>
    <div id="spectrum"></div>
</div>
</body>
</html>